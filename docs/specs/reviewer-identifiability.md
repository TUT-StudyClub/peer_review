# レビューワー識別子（追跡範囲と固定タイミング）

## 選択肢の比較

|案|固定タイミング|追跡できる範囲|メリット|デメリット|
|---|---|---|---|---|
|A: 課題内固定（採用）|assignment_id × user_id をハッシュ化（初回表示時から固定）|同一課題における提出物・レビュー全体で同一レビューワーを追跡可能。課題を跨ぐと別人扱い。|・一度名乗った別タスクでも同じ人物と分かるため、履歴が追いやすい<br>・課題を跨げばリンクされないのでプライバシーを確保<br>・DB保存不要（決定的生成）|・同一課題内では行動が紐づくため、極度の匿名性は下がる|
|B: 提出物ごと固定|submission_id × user_id でハッシュ|同一提出物の複数レビュー間のみ追跡可。提出物が変わると別人扱い。|・追跡範囲が最小化され匿名性が高い|・「前も同じ人がレビューしたか」を確認しづらい<br>・UIでレビューワーを区別しにくい|
|C: レビューごとランダム|レビューごとにランダム ID|追跡不可|・完全匿名|・連続レビュー時の整合性が見えず、メタ評価や不正検知が困難|
|D: 全課題で固定|user_id のみをハッシュ|全課題を跨いで同一人物を追跡可|・長期的なレビューワースキル可視化が容易|・匿名性が低い/複数課題で足跡が残る|

## 採用案
- 案A「課題内固定」を採用する。  
  - 生成式: `alias = HMAC_SHA256(secret_key, f"{assignment_id}:{user_id}")[:8]` を `prefix` と結合（現状仕様を維持）。  
  - 追跡範囲: 同一課題内のみ。課題を跨ぐと別人扱い。  
  - 固定タイミング: 初回の表示/割当て時点から決定的に同じ値を返す（DB保存なし）。  
  - 利用箇所:  
    - レビュー割当取得 (`/assignments/{id}/reviews/next`) の reviewer 表示用  
    - 受信レビュー一覧の reviewer_alias  
    - 将来のTA依頼画面などでの表示も同じアルゴリズムを使用する

## 実装設計（現行との差分）
- 現状の `app/services/anonymize.py::alias_for_user` が採用案Aを満たしているため、アルゴリズム変更なし。  
- ドキュメントとして本ファイルを追加し、仕様を明文化する。
- 追加で必要な配慮:
  - `SECRET_KEY` を環境ごとに適切に管理（ハッシュの衝突回避と秘匿性確保）。
  - 将来的にアルゴリズム変更を行う場合はバージョニング（例: prefix に rev1/ rev2 を含める）を検討。
  - TA依頼や教員向けUIで alias を表示する際も、課題内固定のこの関数を通す。

## 移行
- DBへの新規カラム追加やマイグレーションは不要。  
- 既存の alias 参照箇所は決定的生成のため、そのまま新仕様の定義に従う。  
- もし新しい prefix/形式に変える場合は、「表示だけ切り替える」運用で対応可能（永続化が無いため移行手順は不要）。
